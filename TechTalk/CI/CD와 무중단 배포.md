# CI/CD와 무중단 배포

[[10분 테코톡] 찬, 레넌의 CI/CD와 무중단 배포](http://youtube.com/watch?v=sIPU_VkrguI&list=PLkfxusmKmLsNDGmER2tmrslpPOTfKhE7j&index=109&t=240s)

# CI/CD

**용어 정리**

- 컴파일
    - 프로그래머가 작성한 소스코드를 기계어로 변환하는 과정
- 빌드
    - 소스 코드 파일을 컴퓨터에서 실행할 수 있는 소프트웨어 산출물로 만드는 과정
    - 보통 빌드안에 컴파일 과정이 포함되어 있다.
- 배포
    - 빌드의 결과물을 사용자가 접근할 수 있는 환경에 배치하는 것

## CI (Continuous Integration)

> **지속적 통합**이라는 뜻으로 개발을 진행하면서도 품질을 관리할 수 있도록 여러 명이 하나의 코드에 대해서 수정을 진행해도 지속적으로 통합하면서 관리할 수 있음을 의미한다.
> 

**CI가 있기 전에**

- 개발자들은 Merge Day라는 날을 통해 모든 분기 소스를 통합
    - Merge를 마친 후 에러를 발견하면 에러를 찾기가 힘들다.

**CI**

- 코드 작성이 완료될 때마다 자동으로 병합할 수 있다.

**과정**

- Jenkins와 같은 CI툴이 build와 test를 진행한다.
- 이상이 없으면 코드를 병합한다.
- 문제가 발생할 경우 개발자에게 피드백 해준다.

**마틴 파울러가 제시하는 CI의 4가지 규칙**

- 모든 소스코드가 살아 있고 누구든 현재의 소스에 접근할 수 있는 **단일 지점을 유지** 할 것
- **빌드 프로세스를 자동화**해서 누구든 소스로부터 시스템을 빌드할 수 있게 할 것
- **테스팅을 자동화**해서 언제든지 시스템에 대한 건전한 테스트 수트를 실행할 수 있게 할 것
- 누구든 현재 실행파일을 얻으면 지금까지 **가장 완전한 실행 파일을 얻었다는 확신**을 하게 할 것

## CD (Continuous Deployment)

> **지속적 배포**라는 뜻으로 빌드의 결과물을 프로덕션으로 릴리스하는 작업을 자동화하는 것을 의미한다.
> 

**지속적 제공 (Continuous Delivery)와의 차이**

- 지속적 제공은 Code → Build → Test → Staging의 과정만을 거친다.
- 지속적 배포는 추가로 Deploy를 거친다.
    - CI는 Code → Build → Test 까지의 과정이다.
    

### CI/CD흐름

- 개발자가 코드의 병합을 요청한다.
- CI/CD 툴이 Build와 Test를 진행한다.
    - 이때 에러가 발생하면 개발자에게 피드백을 준다.
    - 이상이 없다면 코드를 병합한다.
- 이후 CD과정을 거쳐 서버에 자동으로 Deploy(배포) 한다.

### 정리

- CI
    - 고객의 요구사항에 빠르게 대응하기 위해 나온 XP의 실천방안 중 한 가지
    - 여러 명이 하나의 코드에 대해서 수정을 진행해도 지속적으로 통합하면서 관리할 수 있음을 의미
- CD
    - CI의 연장선에 있는 개념
    - 빌드의 결과물을 프로덕션으로 지속적으로 배포하는 것을 의미

# 무중단 배포

- 새로운 서비스를 시작하기 위해서는 기존 서비스를 종료하고 새로운 서비스를 시작해야한다.
- 이 사이에는 다운 타임이 존재한다.
    - 사용자들은 이 다운타임 동안에 서비스를 이용하지 못한다.
    - 이것을 해결하기 위해 나온 것이 무중단 배포이다.

**무중단 배포 구현 방법**

- AWS에서 Blue-Green 무중단 배포
- 도커를 이용한 무중단 배포
- L4, L7 스위치를 이용한 무중단 배포
- Nginx를 이용한 무중단 배포

**용어 정리**

- 리버스 프록시
    - 인터넷과 서버 사이에 위치한 중계 서버
    - 클라이언트가 요청한 내용을 캐싱
    - 서버 정보를 클라이언트로부터 숨길 수 있어 보안에 용이
- 로드 밸런싱
    - 부하 분산
    - 서버에 가해지는 부하를 분산해주는 역할
    - 하나의 서버가 멈추더라도 서비스 중단 없이 다른 서버가 서비스를 계속 유지할 수 있는 무중단 배포가 가능

## 무중단 배포 방식

### Rolling 배포

> 서버를 차례대로 업데이트 시키는 방식
> 
- 무중단 배포의 가장 기본적인 방식

**과정**

- 세 개의 서버가 있다면
- 먼저 첫 번째 서버에 로드 밸런싱을 라우팅하지 않게 한다.
- 첫 번째 서버를 업데이트한다.
- 업데이트가 완료되면 첫 번째 서버에 다시 라우팅한다.
- 이 과정을 두 번 더 반복한다.

**장점**

- 인스턴스를 추가하지 않아도 돼서 관리가 간편

**단점**

- 사용중인 인스턴스에 트래픽이 몰릴 수 있음
- 구버전과 신버전의 공존으로 인한 호환성 문제

### Canary 배포

> 신버전을 소수의 사용자들에게만 배포 후, 문제가 없는 것이 확인되면 점진적으로 다른 서버에 신버전 배포하는 방식
> 
- 옛날 광부들이 유독 가스에 민감한 카나리아 새를  이용해 가스 누출 위험을 감지했던 것에서 유래

**과정**

- Rolling 배포와 마찬가지로 첫 번째 서버에 라우팅하지 않게하고 업데이트 한다.
- 다시 라우팅 하도록 설정 한다.
- 이 서버가 문제가 없다는 것이 확인되면 나머지 세 개의 서버에도 차례로 업데이트 한다.

**장점**

- 문제 상황을 빠르게 감지 가능
- A/B 테스트로 활용 가능

**단점**

- 모니터링 관리 비용
- 구버전과 신버전의 공존으로 인한 호환성 문제

### Blue/Green 배포

> 신버전 배포 시 로드 밸런서를 통해 신버전으로만 트래픽을 전환하는 방식
> 
- Blue는 구버전, Green은 신버전을 지칭
- 구버전과 동일하게 신버전의 인스턴스를 구성

**과정**

- 현재 서비스 중인 서버와 대기중인 서버 두 개의 서버가 있다면
- 대기 중인 서버를 업데이트 한다.
- 라우팅을 현재 서비스 중인 서버에서 대기 중인 서버로 전환한다.
- 서비스 중인 서버와 대기 중인 서버가 변경된다.
- 대기 중인 서버는 다음 업데이트에 활용된다.

**장점**

- 배포하는 속도가 빠르다.
- 신속하게 롤백이 가능하다.
- 남아 있는 기존 버전의 환경을 다음 배포에 재사용 가능하다.

**단점**

- 시스템 자원이 두 배로 필요하다.

### 정리

**무중단 배포**

- 다운타임 없이 서버를 운영할 수 있게 해주는 배포 방식
- 방식에는 Rolling, Canary, Blue/Green 방식이 있다.

**리버스 프록시**

- 클라이언트의 요청을 대신 받아 서버에 전달하는 대리 서버

**로드 밸런싱**

- 클라이언트의 요청을 여러 서버에 분산해주는 역할